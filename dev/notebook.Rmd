---
title: "Shiny dashboard development notebook"
author: "Dylan Lewis"
output:
  html_document: 
    toc: true
    toc-location: left
---

# Development notebook

I will use this .rmd doc to develop (mostly back-end) functions for the app. Finished functions will live in the /r/ folder.

```{r setup, include = FALSE}
knitr::opts_chunk$set("echo" = TRUE)
library(tidyverse)
dataPath <- "C:/Users/2808003l/Documents/Sipher"
```

## Data Prep

### Aggregated data

Data is currently aggregated at three resolutions: country, local authority, ward

```{r load aggregated data}
#read country data
ctrDat <- read_csv(paste0(dataPath, "/ROutput/ctr_export_raw.csv"))
glimpse(ctrDat)

#read local autority data
ladDat <- read_csv(paste0(dataPath, "/ROutput/lad_export_raw.csv"))
glimpse(ladDat)

# # read LSOA (2021) data
# lsoaDat <- read_csv(paste0(dataPath, "/ROutput/lsoa21_export_raw.csv"))
# glimpse(lsoaDat)
# #filter to only include all ages/genders
# lsoaDat <- lsoaDat %>% filter(sex=="both", age=="all_ages")

#read ward data
wardDat <- read_csv(paste0(dataPath, "/ROutput/ward_export_raw.csv"))
glimpse(wardDat)
#filter to only include all ages/genders
wardDat <- wardDat %>% filter(sex=="both", age=="all_ages")

#read GB data
gbDat <- read_csv(paste0(dataPath, "/ROutput/gb_export_raw.csv"))
glimpse(gbDat)
```


### Geo lookup



```{r lookup 2}
# lookup file for wards
lookup_wd_lad <- read_csv(paste0(dataPath, "/geo_lookup/Ward_to_Local_Authority_District_(December_2022)_Lookup_in_the_United_Kingdom.csv"),
                   show_col_types = FALSE)

lookup_wd_lad <- lookup_wd_lad %>% select(ward = WD22CD, ward_name = WD22NM, lad = LAD22CD, lad_name = LAD22NM)


# lookup_lsoa_lad <- read_csv(paste0(dataPath, 
#                                    "/geo_lookup/LSOA_(2011)_to_LSOA_(2021)_to_Local_Authority_District_(2022)_Lookup_for_England_and_Wales_(Version_2).csv"))
# 
# lookup_lsoa_lad <- lookup_lsoa_lad %>% select(lsoa = LSOA21CD, lsoa_name = LSOA21NM, lad = LAD22CD, lad_name = LAD22NM)

usethis::use_data(lookup_wd_lad)

```


### Shapefiles
Load in shapefiles, filter for LADs available in data
```{r load in shapefiles}
library(sf)
ladSF_raw <- sf::read_sf(paste0(dataPath, "/topo/Local_Authority_Districts/LAD_DEC_2021_GB_BUC.shp"))
wardSF_raw <- sf::read_sf(paste0(dataPath, "/topo/Wards/WD_DEC_22_GB_BSC.shp"))
#lsoaSF_raw <- sf::read_sf(paste0(dataPath, "/topo/LSOA_21/LSOA_2021_EW_BUC.shp")) # not scotland
#remove areas not in dataset
ladSF <- ladSF_raw %>%
  filter(LAD21CD %in% unique(ladDat$lad)) %>%
  rename(lad_name = LAD21NM,
         lad = LAD21CD,
         lad_welsh = LAD21NMW)
wardSF <- wardSF_raw %>%
  filter(WD22CD %in% unique(wardDat$ward)) %>%
  rename(ward_name = WD22NM,
         ward = WD22CD,
         ward_welsh = WD22NMW)
#ggplot(data=ladSF) +geom_sf()
 usethis::use_data(ladSF, overwrite = T)
 usethis::use_data(wardSF, overwrite = T)
```


### Code book
load codebook to translate codes to variable/category names, and reference table for variable information
```{r codebook}
codebook_raw <- read.csv(paste0(dataPath, "/ROutput/lookup_list.csv"))
                            #"/codebook/codebook.csv"))

codebook <- unique(data.frame(code = c(codebook_raw[,1], codebook_raw[,3]),
                       name = c(codebook_raw[,2], codebook_raw[,4])))
codebook$name[which(is.na(codebook$name))] <- codebook$code[which(is.na(codebook$name))]
codebook <- na.omit(codebook)

reference_raw <- read.csv(paste0(dataPath, "/ROutput/polarity_cat_reference.csv"))

reference <- codebook_raw %>%
  select(obs, cat) %>%
  nest(.by = obs, .key = "cats") %>%
  left_join(., reference_raw, by="obs")
reference$cat_reference[which(is.na(reference$cat_reference))] <- reference$obs[which(is.na(reference$cat_reference))]

usethis::use_data(codebook, reference, overwrite = T)
```

### testing maps
```{r}
#testSF <- wardSF %>% filter(WD23CD %in% lookup_wd_lad$WD23CD[lookup_wd_lad$LAD23CD=="E06000001"])
#plot(testSF)
```

### scaling and labelling for graphs

```{r scaling labelling}
pivot_scale_label <- function(dat) {
  dat %>%
  tidyr::pivot_wider(names_from = c(obs, cat), values_from = value, names_sep = "-") %>%
  group_by(age, sex)  %>%
  rename_with(.cols = contains("-"),  ~paste0(.x, "-value")) %>%
  mutate(across(starts_with(reference$obs[!reference$categorical]),
                            ~paste0(round(.x, 1), " (estimated avg.)"),
                            .names = "{.col}-labelled"),
         across(starts_with(reference$obs[reference$categorical]),
                            ~paste0(round(.x, 2), "% (estimate)"),
                            .names = "{.col}-labelled"),
         across(where(is.numeric),
                ~as.vector(scale(.x)),
                .names = "{.col}-scaled")) %>%
  rename_with(.cols = matches("(-labelled)|(-scaled)"), ~str_remove(.x, "-value")) %>%
  ungroup()
} 

pivot_back_long <- function(dat) {
  dat %>%
    pivot_longer(cols = contains("-"), names_to = c("obs", "cat", ".value"), names_sep = "-") #%>%
    #mutate(across(where(is.numeric), ~replace_na(.x, 0)))
}

ladDatScaled <- ladDat %>% pivot_scale_label()
ladDatScaledLong <- ladDatScaled %>% pivot_back_long()

wardDatScaled <- wardDat %>% pivot_scale_label()
wardDatScaledLong <- wardDatScaled %>% pivot_back_long()

#lsoaDatScaled <- lsoaDat %>% pivot_scale_label()
#lsoaDatScaledLong <- lsoaDatScaled %>% pivot_back_long()

gbDatScaled <- gbDat %>% pivot_scale_label()
gbDatScaledLong <- gbDatScaled %>% pivot_back_long() %>% mutate(scaled = 0)

ladDat <- ladDatScaledLong
wardDat <- wardDatScaledLong %>% select(-c(age, sex))
#lsoaDat <- lsoaDatScaledLong %>% select(-c(age, sex))
gbDat <- gbDatScaledLong

usethis::use_data(ladDat, wardDat, gbDat, overwrite = T)
```


